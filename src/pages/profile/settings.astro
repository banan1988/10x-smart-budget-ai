---
import Layout from "../../layouts/Layout.astro";
import ProfileSettingsView from "../../components/ProfileSettingsView.tsx";
import { AppHeader } from "../../components/AppHeader";
import { AppFooter } from "../../components/AppFooter";
import { AppSidebar } from "../../components/AppSidebar";
import { MobileNav } from "../../components/MobileNav";
import { Breadcrumbs } from "../../components/Breadcrumbs";
import type { ProfileSettingsPageVM, UserProfileDto } from "../../types";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

let profile: UserProfileDto | null = null;
let errorMessage: string | null = null;

try {
  const response = await fetch(`${Astro.url.origin}/api/user/profile`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (response.ok) {
    profile = await response.json();
  } else if (response.status === 404) {
    errorMessage = "Profil nie znaleziony. Prosimy skontaktować się z supportem.";
  } else if (response.status === 401) {
    errorMessage = "Sesja wygasła. Zaloguj się ponownie.";
  } else {
    errorMessage = "Błąd serwera. Spróbuj ponownie później.";
  }
} catch (error) {
  // eslint-disable-next-line no-console
  console.error("Error fetching user profile:", error);
  errorMessage = "Błąd serwera. Spróbuj ponownie później.";
}

if (errorMessage) {
  return new Response(errorMessage, {
    status: profile === null && errorMessage.includes("404") ? 404 : 500,
  });
}

const userProfile: ProfileSettingsPageVM = {
  email: user.email,
  nickname: profile?.nickname || null,
  registeredAt: profile?.createdAt || new Date().toISOString(),
  preferences: profile?.preferences || null,
};

const breadcrumbItems = [
  { label: "Strona główna", href: "/" },
  { label: "Profil", href: "/profile" },
  { label: "Ustawienia", href: "/profile/settings" },
];
---

<Layout title="Ustawienia profilu - SmartBudgetAI">
  <div class="flex min-h-screen">
    <div class="hidden lg:block">
      <AppSidebar currentPage="profile" userRole={Astro.locals.user?.role} client:load />
    </div>

    <div class="flex flex-1 flex-col transition-all duration-300" id="main-content">
      <AppHeader
        currentPage="profile"
        userEmail={Astro.locals.user?.email}
        userNickname={Astro.locals.user?.nickname}
        userRole={Astro.locals.user?.role}
        client:load
      />
      <main class="flex-1 bg-background pb-16 lg:pb-0" role="main">
        <div class="container mx-auto px-4 py-8">
          <div class="mb-6">
            <Breadcrumbs items={breadcrumbItems} client:load />
          </div>

          <div class="mb-8">
            <h1 class="text-3xl font-bold tracking-tight">Ustawienia profilu</h1>
            <p class="mt-2 text-muted-foreground">Zarządzaj swoimi danymi osobistymi i preferencjami konta</p>
          </div>

          <ProfileSettingsView userProfile={userProfile} client:load />
        </div>
      </main>
      <AppFooter client:load />
    </div>

    <MobileNav currentPage="profile" client:load />
  </div>
</Layout>
